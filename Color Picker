#!/usr/bin/env bash
set -euo pipefail
export DISPLAY="${DISPLAY:-:0}"

# Dependencies check
for cmd in xclip import notify-send; do command -v "$cmd" &>/dev/null || { echo "Missing: $cmd" >&2; exit 1; }; done
TMP=$(mktemp --suffix=.png); trap 'rm -f "$TMP"' EXIT

post(){ 
    [[ "${WATERMARK:-}" == "1" ]] && { 
        command -v magick &>/dev/null || { echo "Missing: magick" >&2; exit 1; }
        # Watermark subsystem (env overrides supported)
        magick "$FILE" \
            -gravity "${WATERMARK_POS:-southeast}" \
            -pointsize "${WATERMARK_SIZE:-28}" \
            -fill white -undercolor "${WATERMARK_BG:-#00000080}" \
            -annotate +20+20 "${WATERMARK_TEXT:-$(date '+%Y-%m-%d %H:%M')}" \
            "$FILE"
    }
    xclip -selection clipboard -t image/png -i "$FILE" && notify-send -i "$FILE" "Screenshot: $(basename "$FILE")"
    command -v imgcliphist && imgcliphist add
}

colorpicker(){ 
    command -v magick &>/dev/null || { notify-send "Missing: magick"; exit 1; }
    if command -v slop &>/dev/null; then
        import -window root -crop "$(slop --tolerance=0 || exit 1)" "$TMP"
    else
        import "$TMP"
    fi
    hex=$(magick "$TMP" -scale 1x1\! -format "#%[hex:p{0,0}]" info: 2>/dev/null || echo "#??????")
    echo "$hex" | xclip -selection clipboard -i && notify-send -i "$TMP" "Color: $hex"
}

main(){ 
    case "${1:-}" in
        color*)    colorpicker ;;
        *)         capture_selection ;;
    esac
}

main color
